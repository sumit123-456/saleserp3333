<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>New User Registration</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-8px); }
      60% { transform: translateY(-4px); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    body {
      background: linear-gradient(135deg, #e0eef7, #c5b9db, #c7bddb);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      font-family: 'Poppins', sans-serif;
    }

    .card {
      background: linear-gradient(135deg, #e3e8ee, #e2e0fe, #f6f0ff);
      border: none;
      animation: fadeIn 1s ease-in-out;
      width: 100%;
      max-width: 1500px;
    }

    .card-header {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
    }

    .invalid-tooltip {
      background-color: #ec8d1f;
      color: white;
      font-weight: 500;
      border-radius: 5px;
      padding: 5px 10px;
      display: none;
      animation: bounce 0.5s;
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 10;
    }

    .form-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 15px;
    }

    .form-section .form-group {
      flex: 1 1 calc(50% - 1rem);
      position: relative;
    }

    .form-section.align-items-end {
      display: flex;
      align-items: flex-end;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    @media (max-width: 768px) {
      .form-section .form-group {
        flex: 1 1 100%;
      }
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      border: none;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #1e40af, #1d4ed8);
      transform: scale(1.03);
    }

    input.is-invalid, select.is-invalid {
      border-color: #dc3545 !important;
    }
  </style>
</head>

<body>
  <div class="container mt-5 mb-5">
    <div class="card shadow p-3">
      <div class="card-header text-center rounded">
        <h4>New User Registration</h4>
      </div>
      <div class="card-body">
        <form id="registrationForm" novalidate>

          <div class="form-section">
            <div class="form-group">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-control" id="fullName" placeholder="Enter full name" required>
              <div class="invalid-tooltip">Please enter a valid name. Numbers are not allowed.</div>
            </div>

            <div class="form-group">
              <label class="form-label">Email Address</label>
              <input type="email" class="form-control" id="email" placeholder="Enter email" required>
              <div class="invalid-tooltip">Please fill this field!</div>
            </div>

            <div class="form-group">
              <label class="form-label">Phone Number</label>
              <input type="text" class="form-control" id="phone" placeholder="Enter phone number" required>
              <div class="invalid-tooltip">Please enter a valid contact number. Only digits are allowed.</div>
            </div>

            <div class="form-group">
              <label class="form-label">Role</label>
              <select class="form-select" id="role" required>
                <option value="" selected disabled>Select Role</option>
                <!-- Role ID 2 is typically for EMPLOYEE, 1 for ADMIN -->
                <option value="2">Employee</option>
                <!-- If you want to support multiple roles, add more options -->
                <!-- <option value="1">Admin</option> -->
              </select>
              <div class="invalid-tooltip">Please select a role!</div>
            </div>

            <div class="form-group">
              <label class="form-label">Team Allocation</label>
              <select class="form-select" id="team" required>
                <option value="" selected disabled>Select Team</option>
                <option>Team A</option>
                <option>Team B</option>
                <option>Team C</option>
                <option>Team D</option>
              </select>
              <div class="invalid-tooltip">Please select a team!</div>
            </div>

            <div class="form-group">
              <label class="form-label">Monthly Call Target</label>
              <input type="number" class="form-control" id="callTarget" placeholder="Enter call target" required>
              <div class="invalid-tooltip">Please enter a valid positive number.</div>
            </div>

            <div class="form-group">
              <label class="form-label">Monthly Sales Target</label>
              <input type="number" class="form-control" id="monthlyTarget" placeholder="Enter monthly target" required>
              <div class="invalid-tooltip">Please enter a valid positive number.</div>
            </div>
          </div>

          <div class="form-section align-items-end">
            <div class="form-group" style="flex: 1 1 50%; max-width: 50%;">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="password" placeholder="Enter password" required>
              <div class="invalid-tooltip">Please fill this field!</div>
            </div>

            <div class="d-flex gap-2 ms-auto" style="flex: 1 1 45%; justify-content: flex-end;">
              <button type="button" class="btn btn-primary" onclick="window.location.href='index.html'">← Previous</button>
              <button type="submit" class="btn btn-primary">Register</button>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Registration Successful</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <i class="bi bi-check-circle-fill text-success fs-1 mb-2"></i>
          <p class="mb-0">The new user has been registered successfully!</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success w-100" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const form = document.getElementById('registrationForm');
    const successModal = new bootstrap.Modal(document.getElementById('successModal'));

    // Check authentication on page load
    window.addEventListener('load', function() {
      const token = localStorage.getItem('authToken');
      console.log('Auth check - Token exists?', !!token); // DEBUG
      console.log('Token value:', token ? token.substring(0, 20) + '...' : 'null'); // DEBUG
      
      if (!token) {
        alert('Please login as an admin user first.\n\nDefault Admin Credentials:\nEmail: admin@saleserp.com\nPassword: admin123');
        window.location.href = 'login.html';
        return;
      }
      console.log('Auth check passed'); // DEBUG
    });

    function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      console.log('Getting auth headers - Token:', token ? 'exists' : 'missing'); // DEBUG
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      let valid = true;

      // Full Name validation
      const fullName = document.getElementById('fullName');
      if (!fullName.value || /\d/.test(fullName.value)) {
        fullName.classList.add('is-invalid');
        valid = false;
      } else fullName.classList.remove('is-invalid');

      // Email validation
      const email = document.getElementById('email');
      if (!email.value) {
        email.classList.add('is-invalid');
        valid = false;
      } else email.classList.remove('is-invalid');

      // Phone validation
      const phone = document.getElementById('phone');
      if (!phone.value || /\D/.test(phone.value)) {
        phone.classList.add('is-invalid');
        valid = false;
      } else phone.classList.remove('is-invalid');

      // Role
      const role = document.getElementById('role');
      if (!role.value) {
        role.classList.add('is-invalid');
        valid = false;
      } else role.classList.remove('is-invalid');

      // Team
      const team = document.getElementById('team');
      if (!team.value) {
        team.classList.add('is-invalid');
        valid = false;
      } else team.classList.remove('is-invalid');

      // Call Target
      const callTarget = document.getElementById('callTarget');
      if (!callTarget.value || Number(callTarget.value) < 0) {
        callTarget.classList.add('is-invalid');
        valid = false;
      } else callTarget.classList.remove('is-invalid');

      // Monthly Target
      const monthlyTarget = document.getElementById('monthlyTarget');
      if (!monthlyTarget.value || Number(monthlyTarget.value) < 0) {
        monthlyTarget.classList.add('is-invalid');
        valid = false;
      } else monthlyTarget.classList.remove('is-invalid');

      // Password
      const password = document.getElementById('password');
      if (!password.value) {
        password.classList.add('is-invalid');
        valid = false;
      } else password.classList.remove('is-invalid');

      if (valid) {
        // Build payload expected by backend (/api/v1/auth/register)
        // Now sending roleId instead of role
        const payload = {
          fullName: fullName.value,
          email: email.value,
          password: password.value,
          phoneNumber: phone.value,
          roleId: Number(role.value), // Changed from role to roleId
          callTarget: Number(callTarget.value),
          monthlyTarget: Number(monthlyTarget.value),
          teamAllocation: team.value
        };

        const token = localStorage.getItem('authToken');
        console.log('Registration submit - Token exists?', !!token); // DEBUG
        console.log('Token value:', token ? token.substring(0, 20) + '...' : 'null'); // DEBUG
        
        if (!token) {
          alert('Session expired. Please login again.\n\nDefault Credentials:\nEmail: admin@saleserp.com\nPassword: admin123');
          window.location.href = 'login.html';
          return;
        }

        const API_BASE = 'http://localhost:9090';
        const headers = getAuthHeaders();
        console.log('Sending registration request with headers:', headers); // DEBUG
        console.log('Payload:', payload); // DEBUG

        fetch(API_BASE + '/api/v1/auth/register', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(payload)
        }).then(async (r) => {
          console.log('Registration response status:', r.status); // DEBUG
          const body = await r.json().catch(() => ({}));
          console.log('Registration response body:', body); // DEBUG
          
          if (r.ok) {
            console.log('Registration successful'); // DEBUG
            successModal.show();
            form.reset();
            // Auto-redirect after 2 seconds
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 2000);
          } else {
            const msg = body.message || body.error || JSON.stringify(body) || 'Registration failed';
            console.error('Registration error:', msg); // DEBUG
            
            // More detailed error message
            if (msg.includes('Role ID')) {
              alert('❌ Registration failed:\nRole ID is invalid or not found.\n\nPossible solutions:\n1. Check if role with ID ' + payload.roleId + ' exists in database\n2. Use correct role ID (EMPLOYEE is usually ID 2)\n3. Check backend logs for more details');
            } else {
              alert('❌ Registration failed:\n' + msg);
            }
          }
        }).catch(err => {
          console.error('Network error during registration:', err);
          alert('❌ Network error while registering.\nMake sure:\n1. Server is running on port 9090\n2. You are logged in as admin\n3. CORS is properly configured\n\nError: ' + err.message);
        });
      }
    });

    // Optional: Fetch available roles from backend on page load
    window.addEventListener('load', function() {
      fetchRoles();
    });

    async function fetchRoles() {
      const token = localStorage.getItem('authToken');
      if (!token) return;
      
      try {
        const response = await fetch('http://localhost:9090/api/v1/roles', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const roles = await response.json();
          populateRoleDropdown(roles);
        }
      } catch (err) {
        console.log('Could not fetch roles, using default', err);
      }
    }

    function populateRoleDropdown(roles) {
      const roleSelect = document.getElementById('role');
      roleSelect.innerHTML = '<option value="" selected disabled>Select Role</option>';
      
      if (roles && roles.length > 0) {
        roles.forEach(role => {
          const option = document.createElement('option');
          option.value = role.roleId || role.id;
          option.textContent = role.roleName || role.name;
          roleSelect.appendChild(option);
        });
      } else {
        // Default fallback
        roleSelect.innerHTML = `
          <option value="" selected disabled>Select Role</option>
          <option value="2">Employee</option>
        `;
      }
    }
  </script>
</body>
</html>